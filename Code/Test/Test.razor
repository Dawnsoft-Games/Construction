@using System;
@using Sandbox;
@using Sandbox.UI;
@using Construction.UI;
@inherits PanelComponent
@namespace Sandbox

<root class="test-root">
	<MaterialPanel class="material-background" @ref="backgroundPanel" />

	<div class="content">
		<div class="title">@MyStringValue</div>



		<div class="field">
			<button @onclick="CreateEntityWithComponent">Create Entity with Component</button>
		</div>
	</div>
</root>

@code
{
	[Property, TextArea] public string MyStringValue { get; set; } = "Hello World!";

	[System.Text.Json.Serialization.JsonIgnore]
	private Panel cachedRootPanel;

	[System.Text.Json.Serialization.JsonIgnore]
	private MaterialPanel backgroundPanel;

	// Direct Material property with asset picker
	[Property]
	public Material Material
	{
		get => _material;
		set
		{
			if ( _material != value )
			{
				_material = value;
				Log.Info( $"Test.razor: Material changed to {(_material != null ? _material.ToString() : "null")}" );
				hasAppliedInitialBackground = false;
				// Don't call TryApplyMaterialBackground here - let OnUpdate handle it
				// because backgroundPanel might not be ready yet
			}
		}
	}

	[Property]
	public Color BackgroundTint
	{
		get => _backgroundTint;
		set
		{
			if ( _backgroundTint != value )
			{
				_backgroundTint = value;
				hasAppliedInitialBackground = false;
				// Don't call TryApplyMaterialBackground here - let OnUpdate handle it
			}
		}
	}

	[Property, Range( -1000f, 1000f )]
	public float MaterialOffsetX
	{
		get => _materialOffsetX;
		set
		{
			if ( _materialOffsetX != value )
			{
				_materialOffsetX = value;
				hasAppliedInitialBackground = false;
			}
		}
	}

	[Property, Range( -1000f, 1000f )]
	public float MaterialOffsetY
	{
		get => _materialOffsetY;
		set
		{
			if ( _materialOffsetY != value )
			{
				_materialOffsetY = value;
				hasAppliedInitialBackground = false;
			}
		}
	}

	[Property, Range( 0.1f, 10f )]
	public float MaterialScale
	{
		get => _materialScale;
		set
		{
			if ( _materialScale != value )
			{
				_materialScale = value;
				hasAppliedInitialBackground = false;
			}
		}
	}

	[Property, Range( 0f, 360f )]
	public float MaterialRotation
	{
		get => _materialRotation;
		set
		{
			if ( _materialRotation != value )
			{
				_materialRotation = value;
				hasAppliedInitialBackground = false;
			}
		}
	}

	[Property, Range( 0f, 360f ), Title( "Rotation X (Pitch)" )]
	public float MaterialRotationX
	{
		get => _materialRotationX;
		set
		{
			if ( _materialRotationX != value )
			{
				_materialRotationX = value;
				hasAppliedInitialBackground = false;
			}
		}
	}

	[Property, Range( 0f, 360f ), Title( "Rotation Y (Yaw)" )]
	public float MaterialRotationY
	{
		get => _materialRotationY;
		set
		{
			if ( _materialRotationY != value )
			{
				_materialRotationY = value;
				hasAppliedInitialBackground = false;
			}
		}
	}

	[Property, Range( 0f, 360f ), Title( "Rotation Z (Roll)" )]
	public float MaterialRotationZ
	{
		get => _materialRotationZ;
		set
		{
			if ( _materialRotationZ != value )
			{
				_materialRotationZ = value;
				hasAppliedInitialBackground = false;
			}
		}
	}

	[Property]
	public bool ParallelToScreen
	{
		get => _parallelToScreen;
		set
		{
			if ( _parallelToScreen != value )
			{
				_parallelToScreen = value;
				hasAppliedInitialBackground = false;
			}
		}
	}

	[Property] private Material _material;
	[Property] private Color _backgroundTint = Color.White;
	[Property] private float _materialOffsetX = 0f;
	[Property] private float _materialOffsetY = 0f;
	[Property] private float _materialScale = 1f;
	[Property] private float _materialRotation = 0f;
	[Property] private float _materialRotationX = 0f;
	[Property] private float _materialRotationY = 0f;
	[Property] private float _materialRotationZ = 0f;
	[Property] private bool _parallelToScreen = false;
	[Property] bool hasAppliedInitialBackground;

	protected override int BuildHash()
	{
		unchecked
		{
			int hash = 17;
			hash = hash * 23 + (MyStringValue?.GetHashCode() ?? 0);
			hash = hash * 23 + (Material?.GetHashCode() ?? 0);
			hash = hash * 23 + BackgroundTint.GetHashCode();
			return hash;
		}
	}

	void CreateEntityWithComponent()
	{
		// Create a simple GameObject and attach the component so it runs in-game.
		var go = new GameObject();
		var comp = go.Components.GetOrCreate<MaterialControlComponent>();

		// Use the selected material
		if ( Material != null )
		{
			comp.Material = Material;

			// Also create a UI MaterialPanel under the root and apply the material there
			try
			{
				var root = ResolveRootPanel();
				if ( root != null )
				{
					var uiPanel = root.AddChild<MaterialPanel>();
					uiPanel.Material = Material;
				}
			}
			catch { }
		}

		comp.BackgroundColor = BackgroundTint;

		TryApplyMaterialBackground();
	}

	protected override void OnUpdate()
	{
		if ( hasAppliedInitialBackground )
		{
			return;
		}

		hasAppliedInitialBackground = TryApplyMaterialBackground();
	}

	bool TryApplyMaterialBackground()
	{
		if ( backgroundPanel == null || !backgroundPanel.IsValid() )
		{
			Log.Warning( "Test.razor: backgroundPanel is null or invalid" );
			return false;
		}

		if ( Material == null )
		{
			Log.Warning( "Test.razor: Material is null, clearing background" );
			backgroundPanel.Material = null;
			return false;
		}

		Log.Info( $"Test.razor: Applying material {Material} with tint {BackgroundTint}, offset ({MaterialOffsetX}, {MaterialOffsetY}), scale {MaterialScale}, rotation (X:{MaterialRotationX}, Y:{MaterialRotationY}, Z:{MaterialRotationZ}), parallelToScreen {ParallelToScreen}" );
		backgroundPanel.Material = Material;
		backgroundPanel.Tint = BackgroundTint;
		backgroundPanel.Offset = new Vector2( MaterialOffsetX, MaterialOffsetY );
		backgroundPanel.Scale = MaterialScale;
		backgroundPanel.RotationX = MaterialRotationX;
		backgroundPanel.RotationY = MaterialRotationY;
		backgroundPanel.RotationZ = MaterialRotationZ;
		backgroundPanel.ParallelToScreen = ParallelToScreen;
		backgroundPanel.Style.BackgroundColor = BackgroundTint;
		Log.Info( $"Test.razor: Successfully applied! backgroundPanel.Material is now {backgroundPanel.Material}" );
		return true;
	}

	Panel ResolveRootPanel()
	{
		if ( cachedRootPanel != null && cachedRootPanel.IsValid() )
		{
			return cachedRootPanel;
		}

		var panel = Panel;
		if ( panel is null )
		{
			return null;
		}

		cachedRootPanel = FindRootPanel( panel );
		return cachedRootPanel;
	}

	Panel FindRootPanel( Panel start )
	{
		var current = start;
		while ( current?.Parent is Panel parent )
		{
			current = parent;
		}

		return current ?? start;
	}
}